# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

events {
  worker_connections 1024;
}

http {

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include	  /etc/nginx/mime.types;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    index   index.php index.html index.htm;

    fastcgi_cache_path /var/cache/nginx/fastcgi_temp levels=1:2 keys_zone=CZONE:15m inactive=60m;
    fastcgi_cache_key "$scheme$request_method$host$request_uri";
    fastcgi_cache_use_stale error timeout invalid_header http_500;
		fastcgi_ignore_headers Cache-Control Expires Set-Cookie;    
    add_header rt-Fastcgi-Cache $upstream_cache_status;

		gzip on;
		gzip_disable “msie6”;
		
		gzip_vary on;
		gzip_proxied any;
		gzip_comp_level 6;
		gzip_buffers 16 8k;
		gzip_http_version 1.1;
		gzip_types text/css text/x-component application/x-javascript application/javascript text/javascript text/x-js text/richtext image/svg+xml text/plain text/xsd text/xsl text/xml image/x-icon application/json application/xml application/xml+rss;

		server {
			client_max_body_size 	20M;	    
      server_name  54.210.190.65;
      root         /var/www/html;

      # Load configuration files for the default server block.
      include /etc/nginx/default.d/*.conf;
      include /var/www/html/nginx.conf;

      location / {

        # Redirect
        set $redirect 0;

        if ($http_x_forwarded_proto != "http") {
          set $redirect 1;
        }

				if ($redirect = 1) {
          rewrite ^(.*)$ http://$server_name$1 permanent;
        }

				index index.php;
        try_files $uri $uri/ /index.php?$args;
      }
      
      location = /robots.txt {				
				rewrite ^/robots.txt /robots.production.txt last;
      }

      # redirect server error pages to the static page /40x.html
      #
      error_page 404 /404.php;
        location = /wp-content/themes/Andrew/404.php {
      }

      # redirect server error pages to the static page /50x.html
      #
      error_page 500 502 503 504 /50x.html;
        location = /50x.html {
      }

      # proxy the PHP scripts to Apache listening on 127.0.0.1:80
      #
      #location ~ \.php$ {
      #    proxy_pass   http://127.0.0.1;
      #}

      # FAST CGI CONFIG
      set $no_cache 0;

      if ($request_method = POST) {
          set $no_cache 1;
      }

      if ($query_string != "") {
          set $no_cache 1;
      }

      if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|/wp-(app|cron|login|register|mail).php|wp-.*.php|/feed/|index.php|wp-comments-popup.php|wp-links-opml.php|wp-locations.php|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
        set $no_cache 1;
      }

      if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        set $no_cache 1;
      }

      # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
      #
      location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include /etc/nginx/fastcgi_params;
        fastcgi_intercept_errors off;
        fastcgi_ignore_client_abort off;
        fastcgi_connect_timeout 60;
        fastcgi_send_timeout 90;
       	fastcgi_read_timeout 90;
       	fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        fastcgi_cache_bypass $no_cache;
        fastcgi_no_cache $no_cache;
        fastcgi_cache   CZONE;
        fastcgi_cache_valid   200 302  1h;
        fastcgi_cache_valid   301 1h;
        fastcgi_cache_valid   any 1h;
        fastcgi_cache_min_uses  2;
      }

      location ~* \.(eot|ttf|woff)$ {
        add_header Access-Control-Allow-Origin *;
      }
      
			# Deny access to the nginx.conf file generated by W3TC
			location = /nginx.conf {
			  deny all;
			}
			
			location ~ \.(css|htc|less|js|js2|js3|js4) {
		    expires 31536000s;
		    add_header Pragma "public";
		    add_header Cache-Control "max-age=31536000, public, must-revalidate, proxy-revalidate";
		    add_header Vary "Accept-Encoding";    
			}
			
			location ~ \.(html|htm|rtf|rtx|svg|svgz|txt|xsd|xsl|xml)$ {
		    expires 3600s;
		    add_header Pragma "public";
		    add_header Cache-Control "max-age=3600, public, must-revalidate, proxy-revalidate";
			}
			
			location ~ \.(asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|eot|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|json|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|otf|odb|odc|odf|odg|odp|ods|odt|ogg|pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|tif|tiff|ttf|ttc|wav|wma|wri|woff|xla|xls|xlsx|xlt|xlw|zip)$ {
		    expires 31536000s;
		    add_header Pragma "public";
		    add_header Cache-Control "max-age=31536000, public, must-revalidate, proxy-revalidate";
			}	
    }
}
